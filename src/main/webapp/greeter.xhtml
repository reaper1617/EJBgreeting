<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>ejb-in-war</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>


</head>

<body>
<div>
    <div class = "container-fluid">
        <nav class="nav nav-tabs bg-dark navbar-dark fixed-top">
            <a class="navbar-brand" href="#">WWL Client</a>
            <!-- Nav tabs -->
        </nav>
    </div>

    <div id="container">

        <h:form id="ordersListForm">
            <br></br>
            <br></br>
            <h1 style="color: #005cbf; font-size: 36px">Last orders:</h1>
            <h:dataTable styleClass="table table-bordered table-active table-hover table-text" value="#{greeter.orders}" var="item">
                <h:column>
                    <f:facet name="header">
                        <p align="center"><h:outputText styleClass="header-table-text" value="Personal number"/></p>
                    </f:facet>
                    <p align="center" class="row-text">#{item.id}</p>
                </h:column>
                <h:column>
                    <f:facet name="header">
                        <p align="center"> <h:outputText styleClass="header-table-text" value="Description"/></p>
                    </f:facet>
                    <p align="center" class="row-text">#{item.description}</p>
                </h:column>
                <h:column>
                    <f:facet name="header">
                        <p align="center"><h:outputText styleClass="header-table-text" value="Date/Time"/></p>
                    </f:facet>
                    <p align="center" class="row-text">#{item.date}</p>
                </h:column>
                <h:column>
                    <f:facet name="header">
                        <p align="center"><h:outputText styleClass="header-table-text" value="Status"/></p>
                    </f:facet>
                    <p align="center" class="row-text">#{item.status}</p>
                </h:column>
            </h:dataTable>
            <h:commandButton style="display:none" id="tableUpdate" value="tableUpdate"
                             action="#{greeter.getOrders}">
            </h:commandButton>
        </h:form>
    </div>
    <div align="center">
        <br></br>
        <br></br>
        <h1 style="color: #005cbf; font-size: 36px">Stats:</h1>
        <h:form id="statsForm">
            <h:panelGrid columns="2" >
                <h:outputLabel styleClass="stats-text">Trucks total:</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfTrucksTotal}" />
            </h:panelGrid>
            <h:panelGrid columns="2">
                <h:outputLabel styleClass="stats-text">Trucks free:</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfTrucksFree}" />
            </h:panelGrid>
            <h:panelGrid columns="2">
                <h:outputLabel styleClass="stats-text">Trucks (not ready):</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfTrucksNotReady}" />
            </h:panelGrid>
            <h:panelGrid columns="2">
                <h:outputLabel styleClass="stats-text">Trucks executing orders:</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfTrucksExecutingOrders}" />
            </h:panelGrid>
            <h:panelGrid columns="2">
                <h:outputLabel styleClass="stats-text">Drivers total:</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfDriversTotal}" />
            </h:panelGrid>
            <h:panelGrid columns="2">
                <h:outputLabel styleClass="stats-text">Drivers free:</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfDriversFree}" />
            </h:panelGrid>
            <h:panelGrid columns="2">
                <h:outputLabel styleClass="stats-text">Drivers executing orders:</h:outputLabel>
                <h:outputLabel styleClass="stats-val" value="#{greeter.statsDTO.numOfDriversExecutingOrders}" />
            </h:panelGrid>
            <h:commandButton style="display:none" id="statsUpdate" value="statsUpdate"
                             action="#{greeter.getStatsDTO}">
            </h:commandButton>
        </h:form>
        <!--<h:form id="response">-->
            <!--<h:panelGrid columns="2">-->
                <!--<h:outputLabel styleClass="last-action-text">Last message from server:</h:outputLabel>-->
                <!--<h:outputLabel styleClass="last-action-val" value="#{greeter.message}" />-->
            <!--</h:panelGrid>-->
        <!--</h:form>-->
    </div>
    <div class = "container-fluid ">
        <nav class="nav nav-tabs bg-dark navbar-dark fixed-bottom">
            <a class="navbar-brand" href="#">WWL Client</a>
        </nav>
    </div>
</div>


<script type="text/javascript">
    // var uri = "ws://" + document.location.host + document.location.pathname +
    var uri = "ws://localhost:8085/ejbgreeting/myendpoint";
    var webSocket = new WebSocket(uri);

    webSocket.onerror = function (ev) {
      webSocket = new WebSocket(uri);
    };

    webSocket.onopen = function (ev) {
        // alert("Socket is opened!");

    };
    webSocket.onmessage = function (ev) {
        // alert("Socket: on message!");
        // alert("received data:" + ev.data.toString());
        var parsed = JSON.parse(ev.data.toString());
        // alert("parsed:" + parsed);
        if (parsed.action === 'ORDER_CREATED' || parsed.action === 'ORDER_UPDATED' || parsed.action === 'ORDER_DELETED'){
            // alert("action=" + parsed.action);
            document.getElementById('ordersListForm:tableUpdate').click();
        }
        if (parsed.action === 'STATS_UPDATED'){
            // alert("action=" + parsed.action);
            document.getElementById('statsForm:statsUpdate').click();
        }
    };
    webSocket.onclose = function (ev) {
        // alert("Socket: on close!")
    };



</script>
</body>



</html>